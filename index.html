<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ONESMUS SITE</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {background-color:#1e3f66;color:white;font-family:Arial,sans-serif;margin:0;padding:0;}
  header {background-color:#14365b;display:flex;justify-content:space-between;align-items:center;padding:10px 20px;}
  header img {height:50px;border-radius:10px;}
  header .menu {display:flex;align-items:center;gap:20px;}
  header button {padding:8px 15px;background-color:#ff4444;color:white;border:none;border-radius:5px;cursor:pointer;}
  .container {padding:20px;}
  h1 {text-align:center;margin-top:10px;}
  .time,.viewer-count {text-align:right;font-size:0.9em;margin:5px 20px;}
  .login,.admin-post,.post,.comment-box,.edit-post-box {background-color:#29487d;padding:15px;margin:20px auto;border-radius:10px;width:90%;max-width:700px;box-sizing:border-box;}
  input,textarea,button {width:100%;padding:10px;margin-top:10px;border:none;border-radius:5px;box-sizing:border-box;}
  textarea {min-height:80px;}
  .reactions button {width:auto;margin:5px 5px 5px 0;}
  .post img,.edit-post-box img {max-width:100%;margin-top:10px;border-radius:10px;}
  .download-btn,.edit-btn,.delete-btn,.save-edit-btn,.cancel-edit-btn {margin-top:10px;margin-right:5px;padding:8px 12px;border:none;border-radius:5px;cursor:pointer;}
  .download-btn,.save-edit-btn,.edit-btn {background-color:#4caf50;color:white;}
  .delete-btn {background-color:#f44336;color:white;}
  .cancel-edit-btn {background-color:#bbb;color:black;}
  .comment-box textarea {width:100%;}
  .comment-box button {background-color:#00aaff;color:white;}
  .timestamp {font-size:0.8em;color:#ddd;margin-top:5px;}
  .comment-time {font-size:0.75em;color:#ccc;margin-left:10px;}
  .admin-actions {margin-top:10px;}
  .admin-actions button {margin-right:5px;}
  .edit-post-box textarea {width:100%;min-height:100px;}
  .edit-post-box input[type="file"] {margin-top:5px;}
  .hidden {display:none!important;}
  .spinner {width:40px;height:40px;border:5px solid #ccc;border-top:5px solid #00aaff;border-radius:50%;animation:spin 1s linear infinite;margin:15px auto;}
  @keyframes spin {100%{transform:rotate(360deg);}}
  @media(max-width:480px){header{flex-direction:column;gap:5px;}h1{font-size:1.5em;}}
</style>
</head>
<body>

<header>
  <img src="logo.jpg" alt="Site Logo">
  <div class="menu">
    <span id="viewerCount" class="viewer-count">Viewers: 0</span>
    <button onclick="logout()">Logout</button>
  </div>
</header>

<div class="time" id="time"></div>

<div class="container">
<h1>ONESMUS SITE</h1>

<div class="login" id="loginBox">
  <h2>Admin Login</h2>
  <input type="text" id="username" placeholder="Username">
  <input type="password" id="password" placeholder="Password">
  <button onclick="login()">Login</button>
</div>

<div class="admin-post hidden" id="adminPost">
  <h2>Post New Update</h2>
  <textarea id="postContent" placeholder="Write your post here..."></textarea>
  <input type="file" id="imageInput" accept="image/*">
  <img id="previewImage" style="display:none; margin-top:10px; max-width:100%;">
  <button onclick="publishPost()">Publish</button>
</div>

<div id="loader" class="spinner"></div>

<div id="postsContainer"></div>

<div class="edit-post-box hidden" id="editPostBox">
  <h2>Edit Post</h2>
  <textarea id="editPostContent"></textarea>
  <img id="editPreviewImage" style="display:none; margin-top:10px; max-width:100%;">
  <input type="file" id="editImageInput" accept="image/*">
  <div class="edit-actions">
    <button class="save-edit-btn" onclick="saveEditedPost()">Save</button>
    <button class="cancel-edit-btn" onclick="cancelEdit()">Cancel</button>
  </div>
  <input type="hidden" id="currentPostId">
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyByX8KkqRnkz9_6PMkMHWOK_zBfOGokgWc",
  authDomain: "onesmus-site.firebaseapp.com",
  projectId: "onesmus-site",
  storageBucket: "onesmus-site.appspot.com",
  messagingSenderId: "354101413054",
  appId: "1:354101413054:web:2f9af29ece088f5baa0aef"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const storage = firebase.storage();

let uploadedImage = "";
let editUploadedImage = "";
let currentEditPost = null;

// Auto-time display
setInterval(()=>{document.getElementById("time").textContent=new Date().toLocaleString();},1000);

// Admin login
function login(){
  const user=document.getElementById("username").value;
  const pass=document.getElementById("password").value;
  if(user==="OnesmoP" && pass==="Onesmo2004"){
    document.getElementById("adminPost").classList.remove("hidden");
    document.getElementById("loginBox").classList.add("hidden");
  } else {alert("Wrong credentials!");}
}
function logout(){
  document.getElementById("adminPost").classList.add("hidden");
  document.getElementById("loginBox").classList.remove("hidden");
}

// Viewer counter
function getVisitorId(){let id=sessionStorage.getItem("vid");if(!id){id=Date.now()+"_"+Math.random().toString(36);sessionStorage.setItem("vid",id);}return id;}
function incrementViewers(){
  const id=getVisitorId();
  const ref=database.ref("viewers/"+id);
  ref.once("value",snap=>{if(!snap.exists()){ref.set(true); database.ref("viewerCount").transaction(c=>(c||0)+1);}});
  database.ref("viewerCount").on("value",s=>{document.getElementById("viewerCount").innerText="Viewers: "+(s.val()||0);});
}

// Image previews
document.getElementById("imageInput").addEventListener("change",e=>{
  const file=e.target.files[0]; if(!file)return;
  const reader=new FileReader();
  reader.onload=function(){uploadedImage=reader.result;document.getElementById("previewImage").src=uploadedImage;document.getElementById("previewImage").style.display="block";};
  reader.readAsDataURL(file);
});
document.getElementById("editImageInput").addEventListener("change",e=>{
  const file=e.target.files[0]; if(!file)return;
  const reader=new FileReader();
  reader.onload=function(){editUploadedImage=reader.result;document.getElementById("editPreviewImage").src=editUploadedImage;document.getElementById("editPreviewImage").style.display="block";};
  reader.readAsDataURL(file);
});

// Publish post
function publishPost(){
  const content=document.getElementById("postContent").value.trim();
  if(!content){alert("Write something!"); return;}
  const time=new Date().toLocaleString();
  const newPostRef=database.ref("posts").push();
  if(uploadedImage){
    const sRef=storage.ref("posts/"+Date.now()+"_img");
    sRef.putString(uploadedImage,'data_url').then(s=>s.ref.getDownloadURL().then(url=>{
      newPostRef.set({content,image:url,timestamp:time,likes:0,loves:0,sads:0,comments:{}});
      document.getElementById("postContent").value=""; uploadedImage=""; document.getElementById("previewImage").style.display="none";
    }));
  } else {
    newPostRef.set({content,image:"",timestamp:time,likes:0,loves:0,sads:0,comments:{}});
    document.getElementById("postContent").value=""; uploadedImage=""; document.getElementById("previewImage").style.display="none";
  }
}

// Load posts in real-time
function loadPosts(){
  database.ref("posts").limitToLast(50).on("value",snap=>{
    const container=document.getElementById("postsContainer"); container.innerHTML="";
    snap.forEach(c=>{
      const p=c.val(); p.id=c.key;
      const div=document.createElement("div"); div.className="post"; div.dataset.postId=p.id;
      const adminActions=document.getElementById("adminPost").classList.contains("hidden")?"":`
        <div class="admin-actions">
          <button class="edit-btn" onclick="editPost('${p.id}')">Edit</button>
          <button class="delete-btn" onclick="deletePost('${p.id}')">Delete</button>
        </div>`;
      let commentsHTML=""; if(p.comments){for(let c in p.comments){commentsHTML+=`<p>${p.comments[c].text} <span class="comment-time">[${p.comments[c].time}]</span></p>`;}}
      div.innerHTML=`
        <p>${p.content}</p>
        ${p.image?`<img src="${p.image}">`:''}
        <div class="timestamp">Published: ${p.timestamp}</div>
        <div class="reactions">
          <button onclick="react('${p.id}','likes')">Like (${p.likes||0})</button>
          <button onclick="react('${p.id}','loves')">Love (${p.loves||0})</button>
          <button onclick="react('${p.id}','sads')">Sad (${p.sads||0})</button>
        </div>
        <div class="comment-box">
          <textarea placeholder="Write a comment..."></textarea>
          <button onclick="addComment(this,'${p.id}')">Comment</button>
          <div class="comments">${commentsHTML}</div>
        </div>
        ${adminActions}
      `;
      container.prepend(div);
    });
    document.getElementById("loader").style.display="none";
  });
}

// Reactions
function react(postId,type){ database.ref("posts/"+postId+"/"+type).transaction(n=>(n||0)+1); }

// Comments
function addComment(btn,postId){
  const text=btn.previousElementSibling.value.trim(); if(!text)return;
  const time=new Date().toLocaleTimeString();
  database.ref("posts/"+postId+"/comments").push({text,time});
  btn.previousElementSibling.value="";
}

// Delete post
function deletePost(postId){ if(confirm("Are you sure?")) database.ref("posts/"+postId).remove(); }

// Edit post
function editPost(postId){
  database.ref("posts/"+postId).get().then(snap=>{
    if(!snap.exists()) return;
    currentEditPost=snap.val(); currentEditPost.id=postId;
    document.getElementById("editPostBox").classList.remove("hidden");
    document.getElementById("editPostContent").value=currentEditPost.content;
    document.getElementById("currentPostId").value=postId;
    const img=document.getElementById("editPreviewImage");
    if(currentEditPost.image){ img.src=currentEditPost.image; img.style.display="block"; } else img.style.display="none";
    document.getElementById("adminPost").style.display="none"; document.getElementById("postsContainer").style.display="none";
  });
}

// Save edited post
function saveEditedPost(){
  const postId=document.getElementById("currentPostId").value;
  const content=document.getElementById("editPostContent").value;
  const file=editUploadedImage || currentEditPost.image || "";
  const time=new Date().toLocaleString();
  database.ref("posts/"+postId).update({content,image:file,timestamp:time});
  cancelEdit();
}

// Cancel edit
function cancelEdit(){
  document.getElementById("editPostBox").classList.add("hidden");
  document.getElementById("adminPost").style.display="block"; 
  document.getElementById("postsContainer").style.display="block"; 
  editUploadedImage="";
}

incrementViewers();
loadPosts();
</script>

</body>
</html>